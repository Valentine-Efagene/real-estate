service: qshelter-authorizer-service

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-1'}
  
  environment:
    NODE_ENV: ${self:provider.stage}
    ROLE_POLICIES_TABLE_NAME: !ImportValue QShelterRolePoliciesTableName
    JWT_SECRET: ${env:JWT_SECRET}
  
  # IAM permissions for authorizer
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:GetItem
            - dynamodb:Query
          Resource:
            - !ImportValue QShelterRolePoliciesTableArn
            - !Join ['', [!ImportValue QShelterRolePoliciesTableArn, '/index/*']]

functions:
  authorizer:
    handler: dist/index.handler
    name: qshelter-authorizer-${self:provider.stage}
    description: JWT authorizer for QShelter HTTP API

# Configure the authorizer for HTTP API
resources:
  Resources:
    HttpApiAuthorizer:
      Type: AWS::ApiGatewayV2::Authorizer
      Properties:
        ApiId: !ImportValue QShelterHttpApiId
        Name: qshelterAuthorizer
        AuthorizerType: REQUEST
        AuthorizerUri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${AuthorizerLambdaFunction.Arn}/invocations'
        AuthorizerPayloadFormatVersion: '2.0'
        AuthorizerResultTtlInSeconds: 300
        IdentitySource:
          - $request.header.Authorization
        EnableSimpleResponses: false

    # Grant API Gateway permission to invoke the authorizer Lambda
    AuthorizerInvokePermission:
      Type: AWS::Lambda::Permission
      Properties:
        FunctionName: !GetAtt AuthorizerLambdaFunction.Arn
        Action: lambda:InvokeFunction
        Principal: apigateway.amazonaws.com
        SourceArn: !Sub 
          - 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiId}/*'
          - ApiId: !ImportValue QShelterHttpApiId

  Outputs:
    AuthorizerFunctionArn:
      Description: ARN of the authorizer Lambda function
      Value: !GetAtt AuthorizerLambdaFunction.Arn
      Export:
        Name: QShelterAuthorizerFunctionArn
    
    AuthorizerId:
      Description: ID of the HTTP API authorizer
      Value: !Ref HttpApiAuthorizer
      Export:
        Name: QShelterAuthorizerId

plugins:
  - serverless-dotenv-plugin
  - serverless-offline

custom:
  dotenv:
    path: .env
