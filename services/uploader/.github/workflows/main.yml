name: Deploy CONTRIBUILD UPLOADER SERVICE

on:
  push:
    branches:
      - main
      - dev

jobs:
  deploy:
    name: deploy
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x]

    concurrency:
      group: contribuild-uploader-service-${{ github.ref_name }}
      cancel-in-progress: true
    
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Set deployment stage
        run: |
          if [ ${{ github.ref }} = 'refs/heads/main' ]; then
            echo "STAGE=main" >> $GITHUB_ENV
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "SECRET_ID=CONTRIB" >> $GITHUB_ENV
            echo "basePath=uploader" >> $GITHUB_ENV
            echo "Deploying to production environment"
          elif [ ${{ github.ref }} = 'refs/heads/dev' ]; then
            echo "STAGE=dev" >> $GITHUB_ENV
            echo "ENVIRONMENT=development" >> $GITHUB_ENV
            echo "SECRET_ID=CONTRIB_DEV" >> $GITHUB_ENV
            echo "basePath=uploader" >> $GITHUB_ENV
            echo "Deploying to development environment"
          else
            echo "Invalid branch"
            exit 1
          fi

      - name: Configure AWS OIDC Contribuild Credentials for deployment
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1
          
      - name: Create S3 bucket and configure CORS
        run: |
          BUCKET_NAME="kontribbucket"
          REGION="us-east-1"
          
          # Check if bucket exists, create if it doesn't
          BUCKET_EXISTS=false
          if ! aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
            echo "Creating bucket $BUCKET_NAME..."
            if [ "$REGION" = "us-east-1" ]; then
              aws s3api create-bucket --bucket "$BUCKET_NAME" --region "$REGION"
            else
              aws s3api create-bucket --bucket "$BUCKET_NAME" --region "$REGION" --create-bucket-configuration LocationConstraint="$REGION"
            fi
          else
            echo "Bucket $BUCKET_NAME already exists"
            BUCKET_EXISTS=true
          fi
          
          # Define required subfolders
          FOLDERS=("mortgage_docs/" "property_docs/" "property_picture/" "profile_pictures/" "contribAssets/")
          
          # Check and create subfolders
          echo "Checking and creating subfolders..."
          # Create a temporary empty file for folder markers
          touch /tmp/empty_file
          for folder in "${FOLDERS[@]}"; do
            if [ "$BUCKET_EXISTS" = true ]; then
              # Check if folder exists
              if aws s3api head-object --bucket "$BUCKET_NAME" --key "$folder" 2>/dev/null; then
                echo "Folder $folder already exists"
              else
                echo "Creating folder $folder..."
                aws s3api put-object --bucket "$BUCKET_NAME" --key "$folder" --body /tmp/empty_file
              fi
            else
              # Bucket was just created, create all folders
              echo "Creating folder $folder..."
              aws s3api put-object --bucket "$BUCKET_NAME" --key "$folder" --body /tmp/empty_file
            fi
          done
          # Clean up temporary file
          rm -f /tmp/empty_file
          
          # Configure CORS based on stage
          if [ "$STAGE" = "main" ]; then
            ALLOWED_ORIGINS='["https://contribuild.ng"]'
          else
            ALLOWED_ORIGINS='["http://localhost:4000","http://localhost:5173","http://dev.localhost:4000"]'
          fi
          
          CORS_CONFIG=$(cat <<EOF
          {
            "CORSRules": [
              {
                "AllowedOrigins": $ALLOWED_ORIGINS,
                "AllowedHeaders": ["*"],
                "AllowedMethods": ["GET", "PUT", "POST", "DELETE", "HEAD"],
                "MaxAgeSeconds": 3000
              }
            ]
          }
          EOF
          )
          
          echo "Configuring CORS for bucket $BUCKET_NAME..."
          echo "$CORS_CONFIG" | aws s3api put-bucket-cors --bucket "$BUCKET_NAME" --cors-configuration file:///dev/stdin
          
          echo "S3 bucket setup completed successfully"
          
      - name: Get AWS Secrets
        run: |
          set +x  # Disable command echoing to prevent secrets from being logged
          
          # Get secrets using the SECRET_ID from environment
          aws secretsmanager get-secret-value --secret-id "$SECRET_ID" --query SecretString --output text > /tmp/secrets.json
          
          # Extract secrets, mask them, and add to environment
          jq -r 'to_entries | .[] | "\(.key)=\(.value)"' /tmp/secrets.json | while IFS='=' read -r key value; do
            if [ -n "$key" ] && [ -n "$value" ]; then
              # Mask the secret value in logs
              echo "::add-mask::$value"
              # Add to environment (this won't echo to logs due to set +x)
              echo "${key}=${value}" >> $GITHUB_ENV
            fi
          done
          
          # Clean up secrets file
          rm -f /tmp/secrets.json
          
          set -x  # Re-enable command echoing
          echo "Secrets loaded successfully (values masked in logs)"

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Deploy to AWS
        run: npx serverless deploy
        env:
          CUSTOM_DOMAIN_HOSTED_ZONE_ID: ${{ env.CUSTOM_DOMAIN_HOSTED_ZONE_ID }}
          CUSTOM_DOMAIN_CERT_ARN: ${{ env.CUSTOM_DOMAIN_CERT_ARN }}
          API_ID: ${{ env.API_ID }}


      - name: Notify Deployment Update on slack
        if: always()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ env.CI_CD_SLACK_WEBHOOK }}
          SLACK_CHANNEL: mofi-logs
          SLACK_COLOR: ${{ job.status }}
          SLACK_TITLE: ${{ env.STAGE }} Deployment
          SLACK_MESSAGE: |
            Environment: ${{ env.ENVIRONMENT }}
            Branch: ${{ github.ref }}
            Stage: ${{ env.STAGE }}
            Status: ${{ job.status }}
            Deployed by: ${{ github.actor }}
            API Endpoint: https://${{ env.DOMAIN }}/${{ env.basePath }}