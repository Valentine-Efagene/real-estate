service: qshelter-user-service

frameworkVersion: '4'

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: us-east-1
  
  httpApi:
    cors: true
    authorizers:
      UserServiceAuthorizer:
        type: request
        functionArn: ${ssm:/qshelter/${self:provider.stage}/authorizer-lambda-arn}
        identitySource: $request.header.Authorization
        enableSimpleResponses: false
        resultTtlInSeconds: 300
        payloadVersion: '2.0'
  
  environment:
    NODE_ENV: ${self:provider.stage}
    STAGE: ${self:provider.stage}
    NOTIFICATIONS_TOPIC_ARN: ${ssm:/qshelter/${self:provider.stage}/notifications-topic-arn, ''}
    FRONTEND_BASE_URL: ${env:FRONTEND_BASE_URL, 'https://mreif.com.ng'}
  
  iam:
    role:
      statements:
        - Effect: Allow
          Action: 
            - ssm:GetParameter
            - ssm:GetParameters
            - ssm:GetParametersByPath
          Resource: arn:aws:ssm:${self:provider.region}:*:parameter/qshelter/${self:provider.stage}/*
        - Effect: Allow
          Action: secretsmanager:GetSecretValue
          Resource: arn:aws:secretsmanager:${self:provider.region}:*:secret:qshelter/${self:provider.stage}/*
        - Effect: Allow
          Action:
            - sns:Publish
          Resource: arn:aws:sns:${self:provider.region}:*:qshelter-${self:provider.stage}-notifications

functions:
  api:
    handler: dist/lambda.handler
    timeout: 29
    memorySize: 512
    runtime: nodejs20.x
    events:
      # Health and docs (public)
      - httpApi: 'GET /health'
      - httpApi: 'GET /api-docs'
      - httpApi: 'GET /openapi.json'
      
      # Auth routes (public)
      - httpApi: 'POST /auth/login'
      - httpApi: 'POST /auth/signup'
      - httpApi: 'POST /auth/refresh'
      - httpApi: 'GET /auth/verify-email'
      - httpApi: 'POST /auth/request-password-reset'
      - httpApi: 'POST /auth/reset-password'
      - httpApi: 'POST /auth/google-token-login'
      
      # Auth routes (protected)
      - httpApi:
          path: /auth/me
          method: GET
          authorizer:
            name: UserServiceAuthorizer
      
      # User routes (protected)
      - httpApi:
          path: /users
          method: GET
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /users/{id}
          method: GET
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /users/{id}
          method: PUT
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /users/{id}
          method: DELETE
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /users/{id}/avatar
          method: PUT
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /users/profile
          method: PATCH
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /users/{id}/suspend
          method: POST
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /users/{id}/reinstate
          method: POST
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /users/{id}/roles
          method: PUT
          authorizer:
            name: UserServiceAuthorizer
      
      # Role routes (protected)
      - httpApi:
          path: /roles
          method: GET
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /roles
          method: POST
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /roles/{id}
          method: GET
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /roles/{id}
          method: PUT
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /roles/{id}
          method: DELETE
          authorizer:
            name: UserServiceAuthorizer
      
      # Tenant routes (protected)
      - httpApi:
          path: /tenants
          method: GET
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /tenants
          method: POST
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /tenants/{id}
          method: GET
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /tenants/{id}
          method: PUT
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /tenants/{id}
          method: DELETE
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /tenants/subdomain/{subdomain}
          method: GET
          authorizer:
            name: UserServiceAuthorizer
      
      # Social routes (protected)
      - httpApi:
          path: /socials
          method: POST
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /socials/{id}
          method: GET
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /socials/{id}
          method: PUT
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /socials/{id}
          method: DELETE
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /socials/user/{userId}
          method: GET
          authorizer:
            name: UserServiceAuthorizer

plugins:
  - serverless-localstack

custom:
  localstack:
    stages:
      - test
    host: http://localhost
    edgePort: 4566
    autostart: false

package:
  patterns:
    - '!src/**'
    - '!test/**'
    - '!tests/**'
    - '!**/*.test.ts'
    - '!**/*.test.js'
    - '!**/*.spec.ts'
    - '!**/*.spec.js'
    - '!dist/**/*.js'
    - '!dist/**/*.d.ts'
    - '!node_modules/@aws-sdk/**'
    - '!node_modules/aws-sdk/**'
    - '!node_modules/prisma/**'
    - '!node_modules/@prisma/engines/**'
    - '!node_modules/@prisma/studio/**'
    - '!node_modules/@prisma/studio-core/**'
    - '!node_modules/@electric-sql/**'
    - '!node_modules/@prisma/client/runtime/*cockroachdb*'
    - '!node_modules/@prisma/client/runtime/*sqlserver*'
    - '!node_modules/@prisma/client/runtime/*postgresql*'
    - '!node_modules/@prisma/client/runtime/*sqlite*'
    - 'dist/**/*.mjs'
    - 'dist/**/*.mjs'
    - '!**/*.map'
    - '!**/*.ts'
    - '!**/*.tsx'
    - '!**/*.md'
    - '!**/.git/**'
    - '!**/.github/**'
    - '!**/Dockerfile'
    - '!**/docker/**'
    - '!node_modules/**/test/**'
    - '!node_modules/**/tests/**'
    - '!node_modules/**/example/**'
    - '!node_modules/**/examples/**'
    - '!node_modules/.prisma/**'
    - 'package.json'

resources:
  Resources:
    HttpApiIdParameter:
      Type: AWS::SSM::Parameter
      Properties:
        Name: /qshelter/${self:provider.stage}/http-api-id
        Type: String
        Value:
          Ref: HttpApi
