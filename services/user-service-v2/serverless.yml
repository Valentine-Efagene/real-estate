service: qshelter-user-service

frameworkVersion: '4'

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: us-east-1
  
  httpApi:
    cors: true
    authorizers:
      UserServiceAuthorizer:
        type: request
        functionArn: ${ssm:/qshelter/${self:provider.stage}/authorizer-lambda-arn}
        identitySource: $request.header.Authorization
        enableSimpleResponses: false
        resultTtlInSeconds: 300
        payloadVersion: '2.0'
  
  environment:
    NODE_ENV: ${self:provider.stage}
    STAGE: ${self:provider.stage}
  
  iam:
    role:
      statements:
        - Effect: Allow
          Action: [ssm:GetParameter, ssm:GetParameters]
          Resource: arn:aws:ssm:${self:provider.region}:*:parameter/qshelter/${self:provider.stage}/*
        - Effect: Allow
          Action: secretsmanager:GetSecretValue
          Resource: arn:aws:secretsmanager:${self:provider.region}:*:secret:qshelter/${self:provider.stage}/*

functions:
  api:
    handler: dist/lambda.handler
    timeout: 60
    memorySize: 512
    runtime: nodejs20.x
    events:
      # Health and docs (public)
      - httpApi: 'GET /health'
      - httpApi: 'GET /api-docs'
      - httpApi: 'GET /openapi.json'
      
      # Auth routes (public)
      - httpApi: 'POST /auth/login'
      - httpApi: 'POST /auth/signup'
      - httpApi: 'POST /auth/refresh'
      - httpApi: 'GET /auth/verify-email'
      - httpApi: 'POST /auth/request-password-reset'
      - httpApi: 'POST /auth/reset-password'
      - httpApi: 'POST /auth/google-token-login'
      
      # Auth routes (protected)
      - httpApi:
          path: /auth/me
          method: GET
          authorizer:
            name: UserServiceAuthorizer
      
      # User routes (protected)
      - httpApi:
          path: /users
          method: GET
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /users/{id}
          method: GET
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /users/{id}
          method: PUT
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /users/{id}
          method: DELETE
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /users/{id}/avatar
          method: PUT
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /users/profile
          method: PATCH
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /users/{id}/suspend
          method: POST
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /users/{id}/reinstate
          method: POST
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /users/{id}/roles
          method: PUT
          authorizer:
            name: UserServiceAuthorizer
      
      # Role routes (protected)
      - httpApi:
          path: /roles
          method: GET
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /roles
          method: POST
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /roles/{id}
          method: GET
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /roles/{id}
          method: PUT
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /roles/{id}
          method: DELETE
          authorizer:
            name: UserServiceAuthorizer
      
      # Tenant routes (protected)
      - httpApi:
          path: /tenants
          method: GET
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /tenants
          method: POST
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /tenants/{id}
          method: GET
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /tenants/{id}
          method: PUT
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /tenants/{id}
          method: DELETE
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /tenants/subdomain/{subdomain}
          method: GET
          authorizer:
            name: UserServiceAuthorizer
      
      # Social routes (protected)
      - httpApi:
          path: /socials
          method: POST
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /socials/{id}
          method: GET
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /socials/{id}
          method: PUT
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /socials/{id}
          method: DELETE
          authorizer:
            name: UserServiceAuthorizer
      - httpApi:
          path: /socials/user/{userId}
          method: GET
          authorizer:
            name: UserServiceAuthorizer

plugins:
  - serverless-offline

package:
  patterns:
    - '!**/*'
    - '!dist/**/*.js'
    - '!dist/**/*.d.ts'
    - 'dist/**/*.mjs'
    - 'node_modules/@prisma/client/**'
    - 'node_modules/.prisma/**'
